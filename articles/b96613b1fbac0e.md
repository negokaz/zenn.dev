---
title: "[akka-http] spray-jsonã§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰22å€‹ã®åˆ¶ç´„ã‚’è¶…ãˆã‚‹"
emoji: "ğŸ«"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Akka", "Scala", "JSON"]
published: true
---

spray-json ã§ JSON ã‚’ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º/ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚‹ã«ã¯ `JsonFormat` ã‚’å®šç¾©ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€Scala ã® case class ã®å‹ã‹ã‚‰ `JsonFormat` ã‚’ç”Ÿæˆã™ã‚‹æ©Ÿèƒ½ãŒã‚ã‚‹ãŸã‚ãã‚Œã»ã©æ‰‹é–“ã¯ã‹ã‹ã‚Šã¾ã›ã‚“ã€‚

```scala
final case class Color(name: String, red: Int, green: Int, blue: Int)
// ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ•° N ã®ã¨ãã€jsonFormatN() ã‚’ä½¿ã£ã¦ JsonFormat ã‚’å®šç¾©ã§ãã‚‹
val colorJsonFormat: JsonFormat[Color] = jsonFormat4(Color)
```

ã—ã‹ã—ã€`jsonFormatN` ã¯ `jsonFormat0` ï½ `jsonFormat22` ã—ã‹ç”¨æ„ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

23 å€‹ä»¥ä¸Šã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹ case class ã‹ã‚‰ `JsonFormat` ã‚’ä½œã‚‹ã«ã¯ã©ã†ã™ã‚Œã°è‰¯ã„ã®ã§ã—ã‚‡ã†ã‹ã€‚

```scala
// 40 å€‹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŒã¤ case class
final case class LargeDocument(field1: String, field2: String, ..., field40: String)
```

è§£æ±ºç­–ã® 1 ã¤ã«ã€case class ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¤‡æ•°ã® case class ã«åˆ†å‰²ã—ãŸä¸Šã§ã€`JsonFormat` ã‚’å®Ÿè£…ã™ã‚‹ã¨ã„ã†æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚

:::message

ä»¥é™ã§ç´¹ä»‹ã™ã‚‹æ–¹æ³•ã¯ `scala: 2.13.4` `akka-https-spray-json: 10.2.4` `spray-json: 10.2.4` ã§å‹•ä½œç¢ºèªã—ã¦ã„ã¾ã™ã€‚ä»Šå¾Œã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã§ä½¿ãˆãªã„ API ãŒå‡ºã¦ããŸã‚Šã€ã‚ˆã‚Šã‚¹ãƒãƒ¼ãƒˆãªæ–¹æ³•ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ãã‚Œãã‚Œã®å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèªã—ã¤ã¤æ¡ç”¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚

:::

## å®Ÿè£…æ–¹æ³•

ã¾ãšã¯ã€ãŸãã•ã‚“ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŒã¤ case classï¼ˆ`LargeDocument`ï¼‰ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä»–ã® case class ã«ã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒ 22 å€‹ä»¥å†…ã«ãªã‚‹ã‚ˆã†ã«åˆ‡ã‚Šå‡ºã—ã¾ã™ã€‚å…ƒã® case class ã¯ã€åˆ‡ã‚Šå‡ºã—ãŸ case class ã‚’å†…åŒ…ã™ã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¾ã™ã€‚

```scala
final case class LargeDocument(part1: LargeDocumentPart1, part2: LargeDocumentPart2)
// ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’åˆ†å‰²ã—ã¦ä»–ã® case class ã«åˆ‡ã‚Šå‡ºã™
final case class LargeDocumentPart1(field1: String, ..., field22: String)
final case class LargeDocumentPart2(field23: String, ..., field40: String)
```

æ¬¡ã«ã€`LargeDocument` ç”¨ã® `JsonFormat` ã‚’å®Ÿè£…ã—ã¾ã™ã€‚`JsonFormat` ã‚’è‡ªåˆ†ã§å®Ÿè£…ã™ã‚‹ã¨ãã¯ Scala ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ JSONï¼ˆ`JsValue`ï¼‰ã«å¤‰æ›ã™ã‚‹ `write` ãƒ¡ã‚½ãƒƒãƒ‰ã¨ã€JSON ã‹ã‚‰ Scala ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ã™ã‚‹ `read` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

---

spray-json ã§ã¯ JSON ã® `object` ã®å€¤ã‚’ `JsObject`ã€`number` ã®å€¤ã‚’ `JsNumber` ã¨ã„ã†å‹ã§è¡¨ç¾ã—ã¾ã™ã€‚ã¾ãŸã€ã“ã‚Œã‚‰ã®å‹ã‚’ç·ç§°ã—ã¦ `JsValue` ã¨ã„ã†æŠ½è±¡çš„ãªå‹ã§è¡¨ç¾ã§ãã¾ã™ã€‚

---

ãã‚Œãã‚Œã€æ¬¡ã®ã‚ˆã†ãªæˆ¦ç•¥ã§å®Ÿè£…ã—ã¾ã™ã€‚

- `def write` (Scala â†’ JSON)
    - ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’åˆ†å‰²ã—ã¦åˆ‡ã‚Šå‡ºã—ãŸ case class ã‚’ãã‚Œãã‚Œ `JsObject` ã«å¤‰æ›
    - å¤‰æ›ã•ã‚ŒãŸ `JsObject` ã‹ã‚‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã ã‘å–ã‚Šå‡ºã—æ–°ãŸãª `JsObject` ã¸ãƒ•ãƒ©ãƒƒãƒˆã«è©°ã‚ãªãŠã™
- `def read`ï¼ˆJSON â†’ Scalaï¼‰
    - JSON ã‚’éƒ¨åˆ†ã”ã¨ã« case class ã¸å¤‰æ›ã—ã€ãã‚Œã‚‰ã‚’ã¾ã¨ã‚ã‚‹ case class ã«è©°ã‚ã‚‹

å…·ä½“çš„ãªå®Ÿè£…ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```scala
object LargeDocumentProtocol extends DefaultJsonProtocol {

  // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’åˆ‡ã‚Šå‡ºã—ãŸ case class ã® JsonFormat ã‚’å®šç¾©
  // toJson/convertTo[T] ã‚’å‘¼ã¶ã®ã«å¿…è¦
  implicit val part1Format: JsonFormat[LargeDocumentPart1] =
    jsonFormat22(LargeDocumentPart1)
  implicit val part2Format: JsonFormat[LargeDocumentPart2] =
    jsonFormat18(LargeDocumentPart2)

  implicit object LargeDocumentJsonFormat extends RootJsonFormat[LargeDocument] {
    // Scala â†’ JSON
    override def write(obj: LargeDocument): JsValue = {
      // JsValue (JsObject) ã‹ã‚‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã ã‘å–ã‚Šå‡ºã™
      val part1Fields: Map[String, JsValue] = obj.part1.toJson.asJsObject.fields
      val part2Fields: Map[String, JsValue] = obj.part2.toJson.asJsObject.fields
      // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒãƒ¼ã‚¸ã—ã¦æ–°ãŸãª JsObject ã«è©°ã‚ç›´ã™
      JsObject(part1Fields ++ part2Fields)
    }
    // JSON â†’ Scala
    override def read(json: JsValue): LargeDocument = {
      // JSON ã‹ã‚‰å¤‰æ›ã—ãŸ LargeDocumentPart1 ã¨ LargeDocumentPart2 ã‚’ LargeDocument ã«è©°ã‚ã‚‹
      // â€» JSON å†…ã«å¤‰æ›å…ˆã® case class ã«ãªã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã£ã¦ã‚‚ spray-json ã§ã¯å˜ã«ç„¡è¦–ã•ã‚Œã‚‹ãŸã‚ã€ã“ã®å®Ÿè£…ãŒã§ãã‚‹
      LargeDocument(json.convertTo[LargeDocumentPart1], json.convertTo[LargeDocumentPart2])
    }
  }
}
```

case class ã‚’åˆ†å‰²ã™ã‚‹ã¨ã€åˆ†å‰²ã—ãŸ case class åŒå£«ã§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‚’é‡è¤‡ã—ã¦å®šç¾©ã—ã¦ã—ã¾ã†ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚`write` å†…ã§é‡è¤‡ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãªã©ã§é–“é•ã„ã‚’æ¤œçŸ¥ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã®ãŒè‰¯ã•ãã†ã§ã™ã€‚

```scala
override def write(obj: LargeDocument): JsValue = {
    val objFields1 = obj.doc1.toJson.asJsObject.fields
    val objFields2 = obj.doc2.toJson.asJsObject.fields
    // é‡è¤‡ã™ã‚‹ã‚­ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
    val duplicateKeys = objFields1.keySet.intersect(objFields2.keySet)
    if (duplicateKeys.nonEmpty) {
    serializationError(s"duplicate key found: ${duplicateKeys}")
    }
    JsObject(objFields1 ++ objFields2)
}
```

## ã•ã„ã”ã«

spary-json ã®æ©Ÿèƒ½ã ã‘ã‚’ä½¿ã£ã¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ 22 å€‹ã®åˆ¶é™ã‚’è¶…ãˆã¦ã¿ã¾ã—ãŸã€‚
ã“ã®åˆ¶ç´„ã¯é–¢æ•°ã®å¼•æ•°ã®æ•°ã‚„ã‚¿ãƒ—ãƒ«ã®è¦ç´ æ•°ã®ä¸Šé™ãŒ 22 ã§ã‚ã‚‹ã¨ã“ã‚ã‹ã‚‰æ¥ã¦ã„ã‚‹ã¨äºˆæƒ³ã—ã¦ã„ã¾ã™ã€‚Scala 3 ã§ã¯[ã“ã®åˆ¶é™ãŒæ’¤å»ƒã•ã‚Œã‚‹](https://dotty.epfl.ch/docs/reference/dropped-features/limit22.html)ã®ã§ã€spray-json ã®ã“ã®åˆ¶é™ã‚‚ç„¡ããªã‚‹ã¨è‰¯ã„ã§ã™ã­ã€‚

ä»Šå›å‹•ä½œç¢ºèªã«ä½¿ã£ãŸã‚³ãƒ¼ãƒ‰ã‚’æ²è¼‰ã—ã¦ãŠãã¾ã™ã€‚IDEA ã® Scratch File ãªã©ã§å®Ÿè¡Œã§ãã¾ã™ã€‚

```scala
import spray.json._

case class LargeDocumentPart1(field1: String, field2: String, field3: String, field4: String, field5: String,
                              field6: String, field7: String, field8: String, field9: String, field10: String,
                              field11: String, field12: String, field13: String, field14: String, field15: String,
                              field16: String, field17: String, field18: String, field19: String, field20: String,
                              field21: String, field22: String)

case class LargeDocumentPart2(field23: String, field24: String, field25: String,
                              field26: String, field27: String, field28: String, field29: String, field30: String,
                              field31: String, field32: String, field33: String, field34: String, field35: String,
                              field36: String, field37: String, field38: String, field39: String, field40: String)

case class LargeDocument(doc1: LargeDocumentPart1, doc2: LargeDocumentPart2)

object LargeDocumentProtocol extends DefaultJsonProtocol {

  implicit val part1Format: JsonFormat[LargeDocumentPart1] = jsonFormat22(LargeDocumentPart1)
  implicit val part2Format: JsonFormat[LargeDocumentPart2]  = jsonFormat18(LargeDocumentPart2)

  implicit object LargeDocumentFormat extends RootJsonFormat[LargeDocument] {
    override def write(obj: LargeDocument): JsValue = {
      val objFields1 = obj.doc1.toJson.asJsObject.fields
      val objFields2 = obj.doc2.toJson.asJsObject.fields
      val duplicateKeys = objFields1.keySet.intersect(objFields2.keySet)
      if (duplicateKeys.nonEmpty) {
        serializationError(s"duplicate key found: ${duplicateKeys}")
      }
      JsObject(objFields1 ++ objFields2)
    }

    def read(json: JsValue): LargeDocument = {
      LargeDocument(json.convertTo[LargeDocumentPart1], json.convertTo[LargeDocumentPart2])
    }
  }
}

import LargeDocumentProtocol._

val obj = LargeDocument(
  LargeDocumentPart1(
    "field1", "field2", "field3", "field4", "field5",
    "field6", "field7", "field8", "field9", "field10",
    "field11", "field12", "field13", "field14", "field15",
    "field16", "field17", "field18", "field19", "field20",
    "field21", "field22"
  ),
  LargeDocumentPart2(
    "field23", "field24", "field25",
    "field26", "field28", "field27", "field29", "field30",
    "field31", "field32", "field33", "field34", "field35",
    "field36", "field37", "field38", "field39", "field40"
  )
)
println(obj.toJson.toString())
// â‡’ {"field1":"field1","field10":"field10","field11":"field11","field12":"field12","field13":"field13","field14":"field14","field15":"field15","field16":"field16","field17":"field17","field18":"field18","field19":"field19","field2":"field2","field20":"field20","field21":"field21","field22":"field22","field23":"field23","field24":"field24","field25":"field25","field26":"field26","field27":"field28","field28":"field27","field29":"field29","field3":"field3","field30":"field30","field31":"field31","field32":"field32","field33":"field33","field34":"field34","field35":"field35","field36":"field36","field37":"field37","field38":"field38","field39":"field39","field4":"field4","field40":"field40","field5":"field5","field6":"field6","field7":"field7","field8":"field8","field9":"field9"}

val json =
  """
  {
    "field1":"field1", "field2":"field2", "field3":"field3", "field4":"field4", "field5":"field5",
    "field6":"field6", "field7":"field7", "field8":"field8", "field9":"field9", "field10":"field10",
    "field11":"field11", "field12":"field12", "field13":"field13", "field14":"field14", "field15":"field15",
    "field16":"field16", "field17":"field17", "field18":"field18", "field19":"field19", "field20":"field20",
    "field21":"field21", "field22":"field22", "field23":"field23", "field24":"field24", "field25":"field25",
    "field26":"field26", "field27":"field27", "field28":"field28", "field29":"field29", "field30":"field30",
    "field31":"field31", "field32":"field32", "field33":"field33", "field34":"field34", "field35":"field35",
    "field36":"field36", "field37":"field37", "field38":"field38", "field39":"field39", "field40":"field40"
  }
  """
println(json.parseJson.convertTo[LargeDocument])
// â‡’ LargeDocument(LargeDocumentPart1(field1,field2,field3,field4,field5,field6,field7,field8,field9,field10,field11,field12,field13,field14,field15,field16,field17,field18,field19,field20,field21,field22),LargeDocumentPart2(field23,field24,field25,field26,field27,field28,field29,field30,field31,field32,field33,field34,field35,field36,field37,field38,field39,field40))
```